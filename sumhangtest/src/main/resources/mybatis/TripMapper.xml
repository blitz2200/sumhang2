<?xml version="1.0" encoding= "UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >


<!-- 여행 게시판  -->
<mapper namespace="tripControlMapper">
		
  	<resultMap id="travelSelectMap" type="trip">
  		<result property="travel" column="TRAVEL" jdbcType="VARCHAR" />
  		<result property="title" column="TITLE" jdbcType="VARCHAR" />
  		<result property="travelDescription" column="TRAVEL_DESCRIPTION" jdbcType="VARCHAR" />
  		<result property="travelStart" column="TRAVEL_START" jdbcType="DATE" />
  		<result property="travelEnd" column="TRAVEL_END" jdbcType="DATE" />
  		<result property="travelPho" column="TRAVEL_PHO" jdbcType="VARCHAR" /> 
  		<result property="travelUserCount" column="TRAVEL_USER_COUNT" jdbcType="NUMERIC" />
  		<result property="travelTag" column="TRAVEL_TAG" jdbcType="VARCHAR" />
  		<result property="likenum" column="likenum" jdbcType="NUMERIC"/>
  	</resultMap>
  	
  	<insert id="addTrip" parameterType="trip">
			INSERT 											
			INTO TBOARD(TRAVEL,TITLE,TRAVEL_DESCRIPTION,TRAVEL_START,TRAVEL_END,TRAVEL_PHO,TRAVEL_USER_COUNT,TRAVEL_TAG)
			VALUES ( 	#{travel},
						#{title},
						#{travelDescription},
						#{travelStart:DATE},
						#{travelEnd:DATE},
						#{travelPho},
						#{travelUserCount},
						#{travelTag} )
	</insert>
	
	<select id="selectTrip" resultMap="travelSelectMap">
	
		select b.TBOARD_NO, b.title, b.travel
		, b.travel_start, b.travel_end
		, b.travel_user_count, b.travel_pho
		, u.user_photo , c.likenum
		, n.participants_num
		from TBOARD b left join 
		(
			select
			TBOARD_NO,
			USER_PHOTO,
			row_num
			from
			(
				select *,
				@num := if(@first_column = TBOARD_NO, @num:= @num + 1, 1) as row_num,
				@first_column:=TBOARD_NO as c
				from tripParticipantsPhotoView order by TBOARD_NO, USER_PHOTO
			) as t
			,
			(
				select @first_column:='',@num:=0
			) as r
			having row_num<![CDATA[<=]]>3  
		) u on( b.TBOARD_NO = u.TBOARD_NO)
		left join participantsNumPerTripView n on (b.TBOARD_NO = n.TBOARD_NO)
		left join tripLikeNumView c on (b.TBOARD_NO = c.TBOARD_NO)
	

	</select>
	
	
	
</mapper>
