<?xml version="1.0" encoding= "UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >


<!-- 여행 게시판  -->
<mapper namespace="tripControlMapper">
		
  	<resultMap id="travelSelectMap" type="trip">
  		<result property="travel" column="TRAVEL" jdbcType="VARCHAR" />
  		<result property="title" column="TITLE" jdbcType="VARCHAR" />
  		<result property="travelDescription" column="TRAVEL_DESCRIPTION" jdbcType="VARCHAR" />
  		<result property="travelStart" column="TRAVEL_START" jdbcType="DATE" />
  		<result property="travelEnd" column="TRAVEL_END" jdbcType="DATE" />
  		<result property="travelPho" column="TRAVEL_PHO" jdbcType="VARCHAR" /> 
  		<result property="travelUserCount" column="TRAVEL_USER_COUNT" jdbcType="NUMERIC" />
  		<result property="travelTag" column="TRAVEL_TAG" jdbcType="VARCHAR" />
  		<result property="likenum" column="likenum" jdbcType="NUMERIC"/>
  		<result property="travelNo" column="TBOARD_NO" jdbcType="NUMERIC"/>
  	</resultMap>
  	
  	<insert id="addTrip" parameterType="java.util.Map" useGeneratedKeys="true">
  	
			INSERT 											
			INTO TBOARD(TRAVEL,TITLE,TRAVEL_DESCRIPTION,TRAVEL_START,TRAVEL_END,TRAVEL_PHO,TRAVEL_USER_COUNT,TRAVEL_TAG,USER_NO)
			VALUES ( 	#{travel},
						#{title},
						#{travelDescription},
						#{travelStart:DATE},
						#{travelEnd:DATE},
						#{travelPho},
						#{travelUserCount},
						#{travelTag},
						#{userNo}
						 )
						
	<selectKey keyProperty="travelNo" resultType="String">
 	   SELECT LAST_INSERT_ID()
 	</selectKey>
	</insert>
	
	<select id="getUserTrip" parameterType="int" resultType="Map">
		SELECT t.TBOARD_NO, t.TITLE, t.TRAVEL_START, t.TRAVEL_END, us.STATUS
		FROM TBOARD t, USER_STATUS us
		WHERE t.TBOARD_NO = us.TBOARD_NO AND us.USER_NO = #{value}
	
	</select>
	
	<select id="getTripUsers" resultType="Map">
		SELECT u.NICK, u.GENDER, u.USER_PHOTO, us.STATUS
		FROM USER u,TBOARD t, USER_STATUS us
		WHERE u.USER_NO = us.USER_NO AND t.TBOARD_NO = us.TBOARD_NO AND t.TBOARD_NO = #{travelNo}
	</select>
	
	<insert id="addUserStatus" parameterType="userStatus">
			INSERT 											
			INTO USER_STATUS(TBOARD_NO, USER_NO, STATUS)
			VALUES ( 	#{tboardNo:NUMERIC},
						#{userNo:NUMERIC},
						#{status:NUMERIC}
						)
	</insert>
	
	<select id="selectTrip" resultMap="travelSelectMap">
	
		select b.TBOARD_NO, b.title, b.travel
		, b.travel_start, b.travel_end
		, b.travel_user_count, b.travel_pho
		, u.user_photo , c.likenum
		, n.participants_num
		from TBOARD b left join 
		(
			select
			TBOARD_NO,
			USER_PHOTO,
			row_num
			from
			(
				select *,
				@num := if(@first_column = TBOARD_NO, @num:= @num + 1, 1) as row_num,
				@first_column:=TBOARD_NO as c
				from tripParticipantsPhotoView order by TBOARD_NO, USER_PHOTO
			) as t
			,
			(
				select @first_column:='',@num:=0
			) as r
			having row_num<![CDATA[<=]]>3  
		) u on( b.TBOARD_NO = u.TBOARD_NO)
		left join participantsNumPerTripView n on (b.TBOARD_NO = n.TBOARD_NO)
		left join tripLikeNumView c on (b.TBOARD_NO = c.TBOARD_NO)
	

	</select>
	
	<select id ="selectTripTimeLine" parameterType="user" resultMap="travelSelectMap">
		select t.travel,t.title,t.travel,t.travel_start,t.travel_end,t.user_no
			from TBOARD t, USER u
		where u.USER_NO=t.USER_NO and u.id=#{id} limit 1;
		
	</select>	
	
   <!-- 메인 상세보기 출력 -->
	<select id="tripDetail" parameterType="trip" resultType="Map">
		select t.travel, t.TBOARD_NO, t.USER_NO, u.user_photo, u.nick,t.title,
			 t.travel_start, t.travel_end, t.TRAVEL_DESCRIPTION,t.TRAVEL_USER_COUNT,
			 t.TRAVEL_PHO	 
			 from TBOARD t, USER u
		where u.USER_NO=t.USER_NO and t.TBOARD_NO = #{travelNo}
	</select>
	
   <!-- 메인 상세보기 수정 -->
	<update id="updateTripDetail" parameterType='trip'>
		update TBOARD set title=#{title}, travel=#{travel}, travel_start=#{travelStart}, 
		travel_end=#{travelEnd}, travel_pho=#{travelPho}, travel_description=#{travelDescription}
		where tboard_no=#{travelNo}
	</update>
	
	
   <!-- 메인 상세보기 삭제 시작 -->
	<delete id="deleteTripDetail" parameterType="int">
		delete from TBOARD where tboard_no=#{travelNo}
	</delete>
	
	
	<!-- 메인상세보기 리플  입력 시적 --> 
	<insert id="tripReply" parameterType="trip">
		insert into TBOARD_RE(tboard_no,user_no,tboard_re_description)
			value (#{travelNo},#{userNo},#{tripDetailReply})
	</insert>
	
	
	<select id="selectTripDetailReply" parameterType="int" resultType="Map">
		select u.nick, tr.TBOARD_RE_DESCRIPTION, 
			   tr.user_no, u.user_photo, tr.TRAVEL_BOARD_REPLY_NO
		from USER u, TBOARD t, TBOARD_RE tr 	
		where  u.USER_NO=tr.USER_NO and t.TBOARD_NO=tr.TBOARD_NO and tr.TBOARD_NO=#{travelNo}
	</select>
	
	<delete id="deleteTripDetailReply" parameterType="int">
		delete from TBOARD_RE where travel_board_reply_no=#{tripDetailReNo}
	</delete>
	
	<update id="updateTripDetailReply" parameterType='trip'>
		update TBOARD_RE set tboard_re_description=#{tripDetailReply}
	    where travel_board_reply_no=#{tripDetailReNo}
	</update>
	
</mapper>
